---
- hosts: monitoringserver
  become: yes
  #become_user: root
  become_method: sudo
  tasks:
    - name: Download alertmanager
      unarchive:
        src: "https://github.com/prometheus/alertmanager/releases/download/v0.16.1/alertmanager-0.16.1.linux-amd64.tar.gz"
        dest: /tmp/
        remote_src: yes  

    - name: Add alertmanager user
      user:
        name: alertmanager
        system: yes
        createhome: no
        shell: /bin/false

    - name: Install Prometheus alert manager systemd service
      template:
        src: alertmanager.service.j2
        dest: /etc/systemd/system/alertmanager.service
      notify:
        - reload daemon
    
    - name: Start alertmanager service
      service:
        name: alertmanager
        state: started
        enabled: yes

    - name: Check if alertmanager is accessible
      uri:
        url: http://localhost:9093
        method: GET
        status_code: -1

    - name: enable alertmanager
      command: sudo systemctl restart prometheus-alertmanager


        